name: Setup Ruby

on:
  pull_request:
    paths:
      - "**setup-ruby**"
      - "package.json"
      - "package-lock.json"
      - "node_modules/**"

permissions: {}

jobs:
  setup:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            name: macOS (formula)
            portable: false
          - os: macos-latest
            name: macOS (portable)
            portable: true
          - os: ubuntu-latest
            name: Ubuntu (latest, formula)
            portable: false
          - os: ubuntu-latest
            name: Ubuntu (latest, portable)
            portable: true
          - os: ubuntu-slim
            name: Ubuntu (slim, formula)
            portable: false
          - os: ubuntu-slim
            name: Ubuntu (slim, portable)
            portable: true
    runs-on: ${{ matrix.os }}
    name: Setup Ruby on ${{ matrix.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Set up Ruby
        id: set-up-ruby
        uses: ./setup-ruby/
        with:
          setup-homebrew: true
          portable-ruby: ${{ matrix.portable }}

      - name: Test Ruby
        env:
          PORTABLE_RUBY: ${{ matrix.portable }}
          RUBY_PATH: ${{ steps.set-up-ruby.outputs.ruby-path }}
          RUBY_PREFIX: ${{ steps.set-up-ruby.outputs.ruby-prefix }}
          RUBY_VERSION: ${{ steps.set-up-ruby.outputs.ruby-version }}
        run: |
          test -x "${RUBY_PATH}"
          ruby_bin="$(dirname "${RUBY_PATH}")"
          test "${ruby_bin}" = "${RUBY_PREFIX}/bin"
          case ":${PATH}:" in
            *":${ruby_bin}:"*) ;;
            *) echo "Expected ${ruby_bin} in PATH"; exit 1 ;;
          esac
          test "$("${RUBY_PATH}" -e 'print RUBY_VERSION')" = "${RUBY_VERSION}"

          if [[ "${PORTABLE_RUBY}" == "true" ]]; then
            expected="$(brew --repository)/Library/Homebrew/vendor/portable-ruby/current/bin/ruby"
            test "${RUBY_PATH}" = "${expected}"
          else
            test "${RUBY_PREFIX}" = "$(brew --prefix ruby)"
          fi

  bundler-cache:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: Ubuntu (formula)
            portable: false
          - os: ubuntu-latest
            name: Ubuntu (portable)
            portable: true
          - os: macos-latest
            name: macOS (formula)
            portable: false
          - os: macos-latest
            name: macOS (portable)
            portable: true
    runs-on: ${{ matrix.os }}
    name: Setup Ruby Bundler cache on ${{ matrix.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Set up Ruby for bundler-cache test prep
        uses: ./setup-ruby/
        with:
          setup-homebrew: true
          portable-ruby: ${{ matrix.portable }}

      - name: Prepare Gemfile
        run: |
          cat > Gemfile <<'EOF'
          source "https://rubygems.org"

          gem "rake"
          EOF

      - name: Prepare Gemfile.lock
        run: bundle lock

      - name: Set up Ruby with Bundler cache
        uses: ./setup-ruby/
        with:
          setup-homebrew: true
          portable-ruby: ${{ matrix.portable }}
          bundler-cache: true

      - name: Run setup-ruby again with Bundler cache
        uses: ./setup-ruby/
        with:
          setup-homebrew: true
          portable-ruby: ${{ matrix.portable }}
          bundler-cache: true

      - name: Test Bundler cache result
        run: |
          test -d vendor/bundle
          bundle check
